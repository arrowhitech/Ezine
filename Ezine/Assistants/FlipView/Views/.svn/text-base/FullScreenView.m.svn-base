
#import "FullScreenView.h"
#import "EzineAppDelegate.h"
#import "NSString+HTML.h"
#import "GTMNSString+HTML.h"
#import "DetailArticleViewController.h"

#import "LTTextView.h"
#import "NSAttributedString+HTML.h"
#import "LTTextImageView.h"
#import "DTTextAttachment.h"
#import "DTAttributedTextView.h"
#import <QuartzCore/QuartzCore.h>
#import <MediaPlayer/MediaPlayer.h>
#import "DTHTMLElement.h"
#import "DTCoreTextFontDescriptor.h"
#import "DTCoreTextConstants.h"
#import "DTLinkButton.h"

static const int spaceTop = 10;
static const int spaceBottom= 10;
static const int bottomSpace = 5;

@implementation FullScreenView

@synthesize articleModel,viewToOverLap,fullScreenBG;
@synthesize _imageMain,imageLoadingOperation;
@synthesize flipViewController;
@synthesize deletate,cachedDataDetailArtcile;
@synthesize siteNameforFullScr,urlLogoforFullSrc;

@synthesize mediaPlayers;

-(id)initWithModel:(ArticleModel*)model {
	if (self = [super init]) {
        NSLog(@"model===%d",model._ArticleID);
        _arrayViewDetailArticle=[[NSMutableArray alloc] init];
        _arrayViewDetailArticleLandScape=[[NSMutableArray alloc] init];
        _currentOrientation=[UIApplication sharedApplication].statusBarOrientation;
        cachedDataDetailArtcile=nil;
        [[UIDevice currentDevice] orientation] ;
        [[UIDevice currentDevice] beginGeneratingDeviceOrientationNotifications];
        [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(orientationChanged) name:UIDeviceOrientationDidChangeNotification object:nil];
        
		articleModel = model;
        
        //self.dicForArticleDetail =model.DictForArticleDetail;
        NSLog(@"DictForArticleDetail==%@",model.DictForArticleDetail);
		[self setBackgroundColor:RGBCOLOR(243,243,243)];
                        
        
		contentView = [[DetailArticleView alloc] init];
        [contentView setBackgroundColor:RGBCOLOR(243,243,243)];
        
        
        title = [[UILabel alloc] init];
        title.font =[UIFont boldSystemFontOfSize:30+XAppDelegate.appFontSize];
        [title setTextColor:[UIColor whiteColor]];
        [title setBackgroundColor:[UIColor clearColor]];
        [self addSubview:title];
        //[contentView addSubview:title];
        
        
        time_ago = [[UILabel alloc] init];
        [time_ago setText:articleModel.time_ago];
        time_ago.font =[UIFont fontWithName:@"UVNHongHaHep" size:18+XAppDelegate.appFontSize];
        [time_ago setTextColor:[UIColor whiteColor]];
        [time_ago setBackgroundColor:[UIColor clearColor]];
        [self addSubview:time_ago];
        
		closeButton = [[UIButton buttonWithType:UIButtonTypeCustom] retain];
        closeButton.showsTouchWhenHighlighted=YES;
        
		[self addSubview:contentView];
        
        /*
         Init FlipviewController
         */
        activeIndex=0;
        self.flipViewController = [[MPFlipViewController alloc] initWithOrientation:[self flipViewController:nil orientationForInterfaceOrientation:[UIApplication sharedApplication].statusBarOrientation]];
        self.flipViewController.delegate = self;
        self.flipViewController.dataSource = self;
        CGRect pageViewRect = self.bounds;
        self.flipViewController.view.autoresizingMask = UIViewAutoresizingFlexibleLeftMargin | UIViewAutoresizingFlexibleTopMargin | UIViewAutoresizingFlexibleRightMargin | UIViewAutoresizingFlexibleBottomMargin;
        self.flipViewController.view.frame = pageViewRect;
        //   [self addChildViewController:self.flipViewController];
        [self addSubview:self.flipViewController.view];
        // [self.flipViewController didMoveToParentViewController:self];
        self.gestureRecognizers = self.flipViewController.gestureRecognizers;
        if(![self connected]){
            
            NSLog(@"Not connect to internet");
            [self fetchedData:model.DictForArticleDetail];
            
        }else{
            
            NSLog(@"InternetConnected");
            [XAppDelegate.serviceEngine GetArticleDetail:model._ArticleID onCompletion:^(NSDictionary* data) {
                [self fetchedData:data];
                
            } onError:^(NSError* error) {
                UIAlertView *alert=[[UIAlertView alloc] initWithTitle:@"Error" message:@"Can not connect to service" delegate:self cancelButtonTitle:@"done" otherButtonTitles: nil];
                [alert show];
                [alert release];
                [self closeFullScreenView];
            }];
            
        }

	}
	return self;
}

- (void)reAdjustLayout{
    [self buildLayoutDetailArticle];
    //
    //    [contentView setFrame:CGRectMake(0, 0, self.frame.size.width, self.frame.size.height)];
    //    CGSize contentViewArea = CGSizeMake(contentView.frame.size.width, contentView.frame.size.height);
    //
    //
    //            [title setFrame:CGRectMake(10, 350, contentViewArea.width-50, 50)];
    //            title.numberOfLines=0;
    //            [title sizeToFit];
    //            [time_ago sizeToFit];
    //            [time_ago setFrame:CGRectMake(title.frame.origin.x, title.frame.origin.y+title.frame.size.height+bottomSpace, title.frame.size.width, 28)];
    //
    //            [imageView setFrame:CGRectMake(title.frame.origin.x, time_ago.frame.origin.y+time_ago.frame.size.height+bottomSpace, contentViewArea.width/2.0-40, contentViewArea.height-time_ago.frame.origin.y-time_ago.frame.size.height-bottomSpace)];
    //
    //            [closeButton setFrame:CGRectMake(contentViewArea.width - 30, 0, 30, 30)];
    //
    //            [text_content sizeToFit];
    //            [text_content setFrame:CGRectMake(imageView.frame.origin.x+imageView.frame.size.width+5, imageView.frame.origin.y , contentViewArea.width-imageView.frame.origin.x-imageView.frame.size.width-5, imageView.frame.size.height)];
    //        //    [text_content setText:articleModel.text_content];
    //            text_content.contentMode =UIViewContentModeLeft;
    //
    //        NSString* text = [articledetailModel._content stringByConvertingHTMLToPlainText];
    //        MarkupParser* p = [[[MarkupParser alloc] init] autorelease];
    //        [p setFont:@"TimesNewRomanPSMT"];
    //        NSAttributedString* attString = [p attrStringFromMarkup: text];
    //
    //        [contentView setAttString:attString withImages:Nil];
    //        contentView._textPost=0;
    //        [contentView builtPagePoitrait];
    //    NSLog(@"_TextPost==%d",contentView._textPost);
}


-(void)closeFullScreenView {
    NSLog(@"Close Buttonn==============");
    [[NSNotificationCenter defaultCenter] removeObserver:self name:UIDeviceOrientationDidChangeNotification object:nil];
    viewToOverLap.alpha = 1;
    [self setBackgroundColor:[UIColor whiteColor]];
    //[sender removeFromSuperview];
    [UIView beginAnimations:@"CLOSEFULLSCREEN" context:NULL];
    [UIView setAnimationDuration:0.30];
    [UIView setAnimationTransition:UIViewAnimationTransitionNone forView:nil cache:YES];
    [self setFrame:viewToOverLap.originalRect];
	fullScreenBG.alpha = 0;
    for (UIView* subview in [self subviews]) {
        subview.alpha = 0;
    }
    [UIView setAnimationDelegate:self];
    [UIView setAnimationDidStopSelector:@selector(animationEnd:finished:context:)];
    [UIView commitAnimations];
}

- (void)animationEnd:(NSString*)animationID finished:(NSNumber*)finished context:(void*)context {
    if ([animationID isEqualToString:@"CLOSEFULLSCREEN"]) {
        self.alpha = 0;
        [self removeFromSuperview];
        [[EzineAppDelegate instance] closeFullScreen];
    }
}

-(void)showFields {
	[self reAdjustLayout];
	[UIView beginAnimations:nil context:NULL];
	[UIView setAnimationDuration:0.20];
	[UIView setAnimationTransition:UIViewAnimationTransitionNone forView:nil cache:NO];
	time_ago.alpha = 1;
	closeButton.alpha = 1;
	text_content.alpha = 1;
	[UIView commitAnimations];
}


-(void) dealloc {
	[closeButton release];
	closeButton=nil;
	[imageIconView release];
	imageIconView=nil;
	[titleFeed release];
	titleFeed=nil;
	[time_ago release];
	time_ago=nil;
	[text_content release];
	text_content=nil;
	[scrollView release];
    scrollView=nil;
	[contentView release];
	contentView=nil;
	[super dealloc];
}

#pragma mark--- fetched data
-(void)fetchedData:(NSDictionary *)data{
    if (data==NULL) {
        [self closeFullScreenView];
        return;
    }
    
    if ([data isEqualToDictionary:cachedDataDetailArtcile]) {
        NSLog(@"cached articleDetail");
        return;
    }
    if (_iscache) {
        return;
    }else{
        _iscache=YES;
    }
    [cachedDataDetailArtcile release];
    cachedDataDetailArtcile=[[NSDictionary alloc] initWithDictionary:data copyItems:YES];
    articledetailModel=[[ArticleDetailModel alloc] init];
    articledetailModel._ArticleID=[[data objectForKey:@"ArticleID"] integerValue];
    articledetailModel._SiteID=[[data objectForKey:@"SiteID"] integerValue];
    articledetailModel._commnetCount=[[data objectForKey:@"CommentCount"] integerValue];
    articledetailModel._publishTime=[data objectForKey:@"PublishTime"];
    articledetailModel._caption=[data objectForKey:@"Caption"];
    articledetailModel._title=[data objectForKey:@"Title"];
    articledetailModel._title=[articledetailModel._title stringByConvertingHTMLToPlainText];
    articledetailModel.urlreadWed =[data objectForKey:@"UrlWeb"];
    articledetailModel._content=[data objectForKey:@"Content"];

    articledetailModel._ArticleLandscape=[data objectForKey:@"ArticleLandscape"];
    articledetailModel._articlePortrait=[data objectForKey:@"ArticlePortrait"];
    //    HeaderDetailArticle *header=[[HeaderDetailArticle alloc] initWithFrame:CGRectMake(0, 0, self.frame.size.width, 56)];
    //    [header setWallTitleText:articledetailModel._SiteID];
    //    header.delegate=self;
    [self showFields];
    //
    //    //===
    //    [self addSubview:header];
    
}
#pragma mark--
- (void) ezineButtonClicked:(id)sender{
    [self closeFullScreenView];
}

#pragma mark--- built layout for detail article
-(void) buildLayoutDetailArticle{
    NSString* text = [articledetailModel._content stringByReplacingPercentEscapesUsingEncoding:NSUTF8StringEncoding];
    
    NSLog(@"text===== %@",text);
    
    MarkupParser* p = [[[MarkupParser alloc] init] autorelease];
    [p setFont:@"TimesNewRomanPSMT"];
    
    _textLenght=0;
    int i=1;
      
    NSData *htmlData = [articledetailModel._content dataUsingEncoding:NSUTF8StringEncoding];
    
    // NSData* htmlData = [NSData dataWithContentsOfFile:path];
    
    CGSize maxImageSize = CGSizeMake(0, 0);
    
    // example for setting a willFlushCallback, that gets called before elements are written to the generated attributed string
	
	// example for setting a willFlushCallback, that gets called before elements are written to the generated attributed string
	void (^callBackBlock)(DTHTMLElement *element) = ^(DTHTMLElement *element) {
		// if an element is larger than twice the font size put it in it's own block
		if (element.displayStyle == DTHTMLElementDisplayStyleInline && element.textAttachment.displaySize.height > 2.0 * element.fontDescriptor.pointSize)
		{
			element.displayStyle = DTHTMLElementDisplayStyleBlock;
		}
	};
	float sizeText=1.2+XAppDelegate.appFontSize/10.0;
	NSDictionary *options1 = [NSDictionary dictionaryWithObjectsAndKeys:[NSNumber numberWithFloat:sizeText], NSTextSizeMultiplierDocumentOption, [NSValue valueWithCGSize:maxImageSize], DTMaxImageSize,
                             @"Times New Roman", DTDefaultFontFamily,  @"purple", DTDefaultLinkColor, callBackBlock, DTWillFlushBlockCallBack, nil];
    
    
    
    NSMutableAttributedString* attString = [[NSMutableAttributedString alloc] init];
   

    [attString appendAttributedString:[[NSAttributedString alloc] initWithHTMLData:htmlData
                                                                            options:options1
                                                                 documentAttributes:NULL]];
//    [DTAttributedTextContentView setLayerClass:[CATiledLayer class]];
//    _textView = [[DTAttributedTextView alloc] initWithFrame:self.frame];
//    _textView.textDelegate = self;
//    _textView.autoresizingMask = UIViewAutoresizingFlexibleWidth;
//    //[self addSubview:_textView];
//
//    _textView.contentView.edgeInsets = UIEdgeInsetsMake(10, 10, 10, 10);
//	_textView.contentView.shouldDrawLinks = YES; // we draw them in DTLinkButton
//	_textView.attributedString = attString;
//    
//	[_textView setContentInset:UIEdgeInsetsMake(0, 0, 44, 0)];
//	[_textView setScrollIndicatorInsets:UIEdgeInsetsMake(0, 0, 44, 0)];
//	_textView.autoresizingMask = UIViewAutoresizingFlexibleWidth | UIViewAutoresizingFlexibleHeight;
//    
//    [_textView.contentView layoutSubviewsInRect:self.bounds];

    //[self bringSubviewToFront:_textView];
    // make array View controller article poitrait
   // NSString *str = [attString1 string];
    
    //NSAttributedString* attString = [p attrStringFromMarkup: str];
    
    while (_textLenght<[attString length]) {
        DetailArticleView *detailArticle=[[DetailArticleView alloc] init];
        detailArticle.articleModel=articledetailModel;
        [detailArticle setFrame:CGRectMake(0, 50, 768, 1004)];
        [detailArticle setAttString:attString withImages:Nil];
        detailArticle._textPost=_textLenght;
        detailArticle._numberPage=i;
        [detailArticle buildFramesArticle:UIInterfaceOrientationPortrait];
        _textLenght=detailArticle._textPost;
        NSLog(@"textPost== %d  %d",_textLenght,attString.length);
        DetailArticleViewController *detailViecontroller=[[DetailArticleViewController alloc] init];
        [detailViecontroller.view setFrame:CGRectMake(0, 0, 768, 1004)];
        [detailViecontroller.view setBackgroundColor:[UIColor whiteColor]];
        [detailViecontroller.view addSubview:detailArticle];
        
        [_arrayViewDetailArticle addObject:detailViecontroller];
        i++;
    }
    for (int j=0; j<[_arrayViewDetailArticle count]; j++) {
        DetailArticleViewController *detailViecontroller=[_arrayViewDetailArticle objectAtIndex:j];
        HeaderDetailArticle *header=[[HeaderDetailArticle alloc] initWithFrame:CGRectMake(0, 0, self.frame.size.width, 56)];
        [header setWallTitleText:articledetailModel._SiteID];
        header.delegate=self;
        [header reAdjustLayout:UIInterfaceOrientationPortrait];
        [detailViecontroller.view addSubview:header];
        
        FooterDetaiArticleView *footerview=[[FooterDetaiArticleView alloc] initWithFrame:CGRectMake(0, self.frame.size.height-100, self.frame.size.width, 100)];
        [footerview setBackgroundColor:[UIColor whiteColor]];
        footerview.delegate =self;
        footerview._curentPage=j+1;
        footerview._articleID=articleModel._ArticleID;
        footerview._allpage=[_arrayViewDetailArticle count];
        [footerview setdataWithModel:articledetailModel];
        [footerview reAdjustLayout:UIInterfaceOrientationPortrait];
        [detailViecontroller.view addSubview:footerview];
        
    }
    NSLog(@"_ArrayDetailview count==%d",_arrayViewDetailArticle.count);
    // make array View controller article landScape
    i=1;
    _textLenght=0;
    while (_textLenght<[attString length]) {
        DetailArticleView *detailArticle=[[DetailArticleView alloc] init];
        detailArticle.articleModel=articledetailModel;
        [detailArticle setFrame:CGRectMake(0, 50, 1024, 748)];
        [detailArticle setAttString:attString withImages:Nil];
        detailArticle._textPost=_textLenght;
        detailArticle._numberPage=i;
        [detailArticle buildFramesArticle:UIInterfaceOrientationLandscapeLeft];
        _textLenght=detailArticle._textPost;
        NSLog(@"textPost== %d  %d",_textLenght,attString.length);
        DetailArticleViewController *detailViecontroller=[[DetailArticleViewController alloc] init];
        [detailViecontroller.view setFrame:CGRectMake(0, 0, 1024, 748)];
        [detailViecontroller.view setBackgroundColor:[UIColor whiteColor]];
        [detailViecontroller.view addSubview:detailArticle];
        [_arrayViewDetailArticleLandScape addObject:detailViecontroller];
        i++;
    }
    NSLog(@"_ArrayDetailview count==%d",_arrayViewDetailArticleLandScape.count);
    
    for (int j=0; j<[_arrayViewDetailArticleLandScape count]; j++) {
        DetailArticleViewController *detailViecontroller=[_arrayViewDetailArticleLandScape objectAtIndex:j];
        HeaderDetailArticle *header=[[HeaderDetailArticle alloc] initWithFrame:CGRectMake(0, 0, self.frame.size.width, 56)];
         header.urlLogo =self.urlLogoforFullSrc;
        [header setWallTitleText:articledetailModel._SiteID];
        
       
        
        header.delegate=self;
        [header reAdjustLayout:UIInterfaceOrientationLandscapeLeft];
        [detailViecontroller.view addSubview:header];
        
        FooterDetaiArticleView *footerview=[[FooterDetaiArticleView alloc] initWithFrame:CGRectMake(0, self.frame.size.height-100, self.frame.size.width, 100)];
        [footerview setBackgroundColor:[UIColor whiteColor]];
        footerview._curentPage=j+1;
        footerview._articleID=articleModel._ArticleID;
        footerview.sitename =self.siteNameforFullScr;
        footerview.urlLogo =self.urlLogoforFullSrc;
        NSLog(@"  footerview.sitename%@",  footerview.sitename);
        
        footerview._allpage=[_arrayViewDetailArticleLandScape count];
        [footerview setdataWithModel:articledetailModel];
        [footerview reAdjustLayout:UIInterfaceOrientationLandscapeLeft];
        [detailViecontroller.view addSubview:footerview];
    }
    
    ///==================
       ///=========================
    [self.flipViewController.view setFrame:CGRectMake(0, 0, self.frame.size.width, self.frame.size.height)];
    if (_currentOrientation==UIInterfaceOrientationPortrait||_currentOrientation==UIInterfaceOrientationPortraitUpsideDown) {
        NSLog(@"_currentOrientation  ===  %d",_currentOrientation);
        DetailArticleViewController *firstView=[_arrayViewDetailArticle objectAtIndex:0];
        [self.flipViewController setViewController:firstView direction:MPFlipViewControllerDirectionForward animated:NO completion:nil];
        [self setFrame:CGRectMake(0, 0, 768, 1004)];
        [self.flipViewController.view setFrame:CGRectMake(0, 0,768, 1004)];

    }else if (_currentOrientation==UIInterfaceOrientationLandscapeLeft||_currentOrientation==UIInterfaceOrientationLandscapeRight){
        NSLog(@"_currentOrientation  ===  %d",_currentOrientation);

        DetailArticleViewController *firstView=[_arrayViewDetailArticleLandScape objectAtIndex:0];
        [self.flipViewController setViewController:firstView direction:MPFlipViewControllerDirectionForward animated:NO completion:nil];
        [self setFrame:CGRectMake(0, 0, 1024, 748)];
        [self.flipViewController.view setFrame:CGRectMake(0, 0, 1024, 748 )];

    }
   // [self orientationChanged];
    
}

#pragma mark - MPFlipViewControllerDelegate protocol

- (void)flipViewController:(MPFlipViewController *)flipViewController didFinishAnimating:(BOOL)finished previousViewController:(UIViewController*)previousViewController transitionCompleted:(BOOL)completed{
	if (completed){
		
	}
}

- (MPFlipViewControllerOrientation)flipViewController:(MPFlipViewController *)flipViewController orientationForInterfaceOrientation:(UIInterfaceOrientation)orientation
{
	if ([[UIDevice currentDevice] userInterfaceIdiom] == UIUserInterfaceIdiomPhone)
		return UIInterfaceOrientationIsPortrait(orientation)? MPFlipViewControllerOrientationVertical : MPFlipViewControllerOrientationHorizontal;
	else
		return MPFlipViewControllerOrientationHorizontal;
}

#pragma mark - MPFlipViewControllerDataSource protocol

- (UIViewController *)flipViewController:(MPFlipViewController *)flipViewController viewControllerBeforeViewController:(UIViewController *)viewController
{
    if (_currentOrientation==UIInterfaceOrientationPortrait||_currentOrientation==UIInterfaceOrientationPortraitUpsideDown) {
        activeIndex--;
        if (activeIndex>=0) {
            return [_arrayViewDetailArticle objectAtIndex:activeIndex];
        }else{
            activeIndex++;
            return nil;
        }
        
    }else if (_currentOrientation==UIInterfaceOrientationLandscapeLeft||_currentOrientation==UIInterfaceOrientationLandscapeRight){
        activeIndex--;
        if (activeIndex>=0) {
            return [_arrayViewDetailArticleLandScape objectAtIndex:activeIndex];
        }else{
            activeIndex++;
            return nil;
        }
        
    }
    return nil;
}

- (UIViewController *)flipViewController:(MPFlipViewController *)flipViewController viewControllerAfterViewController:(UIViewController *)viewController
{
    if (_currentOrientation==UIInterfaceOrientationPortrait||_currentOrientation==UIInterfaceOrientationPortraitUpsideDown) {
        if ([_arrayViewDetailArticle count]>0) {
            activeIndex++;
            if (activeIndex<=[_arrayViewDetailArticle count]-1) {
                return [_arrayViewDetailArticle objectAtIndex:activeIndex];
            }else{
                activeIndex--;
                return nil;
            }
            
        }
        
    }else if (_currentOrientation==UIInterfaceOrientationLandscapeLeft||_currentOrientation==UIInterfaceOrientationLandscapeRight){
        if ([_arrayViewDetailArticleLandScape count]>0) {
            activeIndex++;
            if (activeIndex<=[_arrayViewDetailArticleLandScape count]-1) {
                return [_arrayViewDetailArticleLandScape objectAtIndex:activeIndex];
            }else{
                activeIndex--;
                return nil;
            }
            
        }
        
    }
    
    return nil;
}

#pragma mark - OrientationChanged

-(void)orientationChanged{
    if (_arrayViewDetailArticle.count==0||_arrayViewDetailArticleLandScape.count==0) {
        return;
    }
    UIInterfaceOrientation orientationK =[UIDevice currentDevice].orientation;
    NSLog(@"orientationChanged fullscreen : %d  %d",currrentInterfaceOrientation,orientationK);

    if (_currentOrientation==orientationK)
        return;
    
    if ([[UIDevice currentDevice] orientation]==UIInterfaceOrientationLandscapeLeft||[[UIDevice currentDevice] orientation]==UIInterfaceOrientationLandscapeRight) {
        _currentOrientation=UIInterfaceOrientationLandscapeLeft;
        [self setFrame:CGRectMake(0, 0, 1024, 748)];
        [self.flipViewController.view setFrame:CGRectMake(0, 0, 1024, 748 )];
        NSLog(@" rotate UIInterfaceOrientationLandscapeLeft  %d",activeIndex);
        if (activeIndex>_arrayViewDetailArticleLandScape.count-1) {
            DetailArticleViewController *firstView=[_arrayViewDetailArticleLandScape lastObject];
            [self.flipViewController setViewController:firstView direction:MPFlipViewControllerDirectionForward animated:NO completion:nil];
            activeIndex=_arrayViewDetailArticleLandScape.count-1;
            
        }else{
            DetailArticleViewController *firstView=[_arrayViewDetailArticleLandScape objectAtIndex:activeIndex];
            [self.flipViewController setViewController:firstView direction:MPFlipViewControllerDirectionForward animated:NO completion:nil];
            
        }
        
    }else if([[UIDevice currentDevice] orientation]==UIInterfaceOrientationPortrait||[[UIDevice currentDevice] orientation]==UIInterfaceOrientationPortraitUpsideDown){
        _currentOrientation=UIInterfaceOrientationPortrait;
        [self setFrame:CGRectMake(0, 0, 768, 1004)];
        [self.flipViewController.view setFrame:CGRectMake(0, 0,768, 1004)];
        NSLog(@"will rotate UIInterfaceOrientationPortrait %d",activeIndex);
        if (activeIndex>_arrayViewDetailArticle.count-1) {
            DetailArticleViewController *firstView=[_arrayViewDetailArticle lastObject];
            [self.flipViewController setViewController:firstView direction:MPFlipViewControllerDirectionForward animated:NO completion:nil];
            activeIndex=_arrayViewDetailArticle.count-1;
            
        }else{
            DetailArticleViewController *firstView=[_arrayViewDetailArticle objectAtIndex:activeIndex];
            [self.flipViewController setViewController:firstView direction:MPFlipViewControllerDirectionForward animated:NO completion:nil];
            
        }
        
    }
}


#pragma mark==========FooterDetailArticeViewDelegate

-(void)shareEmail{
    
    if (self.deletate) {
        [self.deletate shareEmail];
    }
}
-(void)ReadBaseOnWeb{
    if (self.deletate ) {
        [self.deletate ReadBaseOnWeb:articledetailModel.urlreadWed];
    }
    
}
#pragma mark Custom Views on Text

- (UIView *)attributedTextContentView:(DTAttributedTextContentView *)attributedTextContentView viewForAttributedString:(NSAttributedString *)string frame:(CGRect)frame
{
	NSDictionary *attributes = [string attributesAtIndex:0 effectiveRange:NULL];
	
	NSURL *URL = [attributes objectForKey:DTLinkAttribute];
	NSString *identifier = [attributes objectForKey:DTGUIDAttribute];
	
	
	DTLinkButton *button = [[DTLinkButton alloc] initWithFrame:frame];
	button.URL = URL;
	button.minimumHitSize = CGSizeMake(25, 25); // adjusts it's bounds so that button is always large enough
	button.GUID = identifier;
	
	// we draw the contents ourselves
	button.attributedString = string;
	
	// make a version with different text color
	NSMutableAttributedString *highlightedString = [string mutableCopy];
	
	NSRange range = NSMakeRange(0, highlightedString.length);
	
	NSDictionary *highlightedAttributes = [NSDictionary dictionaryWithObject:( id)[UIColor greenColor].CGColor forKey:(id)kCTForegroundColorAttributeName];
	
	
	[highlightedString addAttributes:highlightedAttributes range:range];
	
	button.highlightedAttributedString = highlightedString;
	
	// use normal push action for opening URL
	[button addTarget:self action:@selector(linkPushed:) forControlEvents:UIControlEventTouchUpInside];
	
	// demonstrate combination with long press
	UILongPressGestureRecognizer *longPress = [[UILongPressGestureRecognizer alloc] initWithTarget:self action:@selector(linkLongPressed:)];
	[button addGestureRecognizer:longPress];
	
	return button;
}

- (void)linkPushed:(DTLinkButton *)button
{
    NSURL *URL = button.URL;
	NSLog(@"link plushed  %@",URL);
	
	if ([[UIApplication sharedApplication] canOpenURL:[URL absoluteURL]])
	{
		[[UIApplication sharedApplication] openURL:[URL absoluteURL]];
	}
	else
	{
		if (![URL host] && ![URL path])
		{
            
			// possibly a local anchor link
			NSString *fragment = [URL fragment];
			
			if (fragment)
			{
				[_textView scrollToAnchorNamed:fragment animated:NO];
			}
		}
	}
}

#pragma mark CHeck Internet Avalable=============

-(BOOL)connected{
    
    Reachability *reachability = [Reachability reachabilityForInternetConnection];
    NetworkStatus networkStatus = [reachability currentReachabilityStatus];

    return !(networkStatus == NotReachable);
   
}

@end
